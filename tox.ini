[tox]
envlist =
    py39, py310, py311, py312,
    lint, typing, security, integration, docs, all
isolated_build = true
skip_missing_interpreters = true

[testenv]
description = Run unit tests with coverage
extras =
    test
    tz
commands =
    coverage run --branch -m pytest --tb=short --disable-warnings
    coverage report -m --omit="*/integrations/*"
    coverage html

[testenv:lint]
description = Run code format and lint checks
basepython = python3.12
skip_install = true
deps =
    black
    isort
    pylint
commands =
    python -m black --check --diff src tests
    python -m isort --check-only --diff src tests
    python -m pylint src --ignore=integrations --disable=R0903

[testenv:typing]
description = Run static type checks (targets Py3.9 via pyproject.toml)
basepython = python3.12
extras =
    test
    tz
deps =
    mypy
    django
    sqlalchemy
commands =
    python -m mypy

[testenv:security]
description = Run security scans
basepython = python3.12
skip_install = true
deps =
    bandit
    pip_audit
commands =
    bandit -r src
    python -m pip_audit

[testenv:integration]
description = Run integration tests only
extras =
    test
    tz
deps =
    django
    sqlalchemy
commands =
    pytest tests/integration/ -v

[testenv:docs]
description = Build docs (regenerates docs/source and copies markdown assets)
basepython = python3.12
extras =
    docs
    tz
commands =
    sphinx-apidoc -o docs/source src/eones --force --no-toc --module-first
    python -c "import os, glob; [os.remove(f) for f in glob.glob('docs/source/*.md') if os.path.basename(f) not in ['readme.md', 'changelog.md', 'license.md']]"
    python -c "import os, shutil; shutil.rmtree('docs/source/examples', ignore_errors=True); os.makedirs('docs/source/examples', exist_ok=True)"
    python -c "import os, shutil; shutil.rmtree('docs/source/benchmarks', ignore_errors=True); os.makedirs('docs/source/benchmarks', exist_ok=True)"
    python -c "import shutil; shutil.copy('README.md', 'docs/source/README.md')"
    python -c "import shutil; shutil.copy('benchmarks/README.md', 'docs/source/benchmarks/README.md')"
    python -c "import shutil; shutil.copy('CHANGELOG.md', 'docs/source/CHANGELOG.md')"
    python -c "import shutil; shutil.copy('LICENSE.md', 'docs/source/LICENSE.md')"
    python -c "import shutil; shutil.copy('examples/quick_start.md', 'docs/source/examples/quick_start.md')"
    python -c "import shutil; shutil.copy('examples/advanced_patterns.md', 'docs/source/examples/advanced_patterns.md')"
    python -c "import shutil; shutil.copy('examples/time_deltas.md', 'docs/source/examples/time_deltas.md')"
    python -c "import shutil; shutil.copy('examples/error_handling.md', 'docs/source/examples/error_handling.md')"
    python -c "import shutil; shutil.copy('examples/formatting_serialization.md', 'docs/source/examples/formatting_serialization.md')"
    python -c "import shutil; shutil.copy('examples/real_world_scenarios.md', 'docs/source/examples/real_world_scenarios.md')"
    python -c "import shutil; shutil.copy('examples/regional_configuration.md', 'docs/source/examples/regional_configuration.md')"
    python -m sphinx.cmd.build -b html docs/source docs/_build/html

[testenv:all]
description = Run tests + lint + typing + security + integration (single interpreter)
basepython = python3.12
extras =
    test
    tz
deps =
    black
    isort
    pylint
    mypy
    bandit
    pip_audit
    django
    sqlalchemy
commands =
    pip install -e .
    coverage run --branch -m pytest --tb=short --disable-warnings
    coverage report -m --omit="*/integrations/*"
    python -m black --check --diff src tests
    python -m isort --check-only --diff src tests
    python -m pylint src --ignore=integrations --disable=R0903
    python -m mypy
    bandit -r src
    python -m pip_audit
    pytest tests/integration/ -v
